<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Gestion des Bons de Commande</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            color: #2a4d8f;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }

        .status-connected {
            background: #10b981;
            color: white;
        }

        .status-disconnected {
            background: #ef4444;
            color: white;
        }

        main {
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #2a4d8f;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #374151;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .lignes-container {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f9fafb;
        }

        .ligne-item {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .ligne-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .ligne-header h4 {
            color: #667eea;
            margin: 0;
        }

        .btn-remove-ligne {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-remove-ligne:hover {
            background: #dc2626;
        }

        .btn-add-ligne {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .btn-add-ligne:hover {
            background: #059669;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: right;
        }

        .total-display h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }

        .total-display .montant {
            font-size: 2em;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .btn-create-bc {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-create-bc:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
        .notification.info { background: #3b82f6; }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <header>
        <h1>üè¢ ERP - Gestion des Bons de Commande</h1>
        <p>Cr√©er et g√©rer les bons de commande multi-lignes
            <span id="connection-status" class="status-indicator status-disconnected">‚óè D√©connect√©</span>
        </p>
    </header>

    <main>
        <!-- Demandes d'achat -->
        <section class="card">
            <h2>üìã Demandes d'Achat (DA)</h2>
            <table id="da-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Demandeur</th>
                        <th>D√©partement</th>
                        <th>Type</th>
                        <th>D√©tails</th>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #6b7280;">
                            Chargement...
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Cr√©er un bon de commande -->
        <section class="card">
            <h2>‚ûï Cr√©er un Bon de Commande</h2>
            <form id="bc-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="linked_pr_id">R√©f√©rence DA *</label>
                        <select id="linked_pr_id" required>
                            <option value="">S√©lectionner une DA...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="demandeur_nom">Demandeur *</label>
                        <input type="text" id="demandeur_nom" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="demandeur_email">Email demandeur *</label>
                        <input type="email" id="demandeur_email" required readonly>
                    </div>

                    <div class="form-group">
                        <label for="manager_nom">Manager *</label>
                        <input type="text" id="manager_nom" required>
                    </div>

                    <div class="form-group">
                        <label for="manager_email">Email manager *</label>
                        <input type="email" id="manager_email" required>
                    </div>

                    <div class="form-group">
                        <label for="type_achat">Type d'achat *</label>
                        <select id="type_achat" required>
                            <option value="Produit">Produit</option>
                            <option value="Service">Service</option>
                            <option value="Mixte">Mixte</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fournisseur_nom">Fournisseur *</label>
                        <input type="text" id="fournisseur_nom" required placeholder="ex: Tech Supplies Inc">
                    </div>

                    <div class="form-group">
                        <label for="fournisseur_email">Email fournisseur</label>
                        <input type="email" id="fournisseur_email" placeholder="contact@fournisseur.com">
                    </div>

                    <div class="form-group">
                        <label for="fournisseur_telephone">T√©l√©phone fournisseur</label>
                        <input type="tel" id="fournisseur_telephone" placeholder="+216 XX XXX XXX">
                    </div>

                    <div class="form-group">
                        <label for="priorite">Priorit√© *</label>
                        <select id="priorite" required>
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date_livraison">Date livraison souhait√©e</label>
                        <input type="date" id="date_livraison">
                    </div>

                    <div class="form-group">
                        <label for="mode_paiement">Mode de paiement</label>
                        <select id="mode_paiement">
                            <option value="Virement bancaire" selected>Virement bancaire</option>
                            <option value="Ch√®que">Ch√®que</option>
                            <option value="Esp√®ces">Esp√®ces</option>
                            <option value="Carte bancaire">Carte bancaire</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="details_demande">D√©tails de la demande *</label>
                    <textarea id="details_demande" rows="3" required placeholder="Description g√©n√©rale de la commande..."></textarea>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="justification">Justification *</label>
                    <textarea id="justification" rows="2" required placeholder="Raison de cette commande..."></textarea>
                </div>

                <!-- Lignes de commande -->
                <div class="lignes-container">
                    <h3 style="color: #2a4d8f; margin-bottom: 15px;">üì¶ Lignes de Commande</h3>
                    <div id="lignes-list"></div>
                    <button type="button" class="btn-add-ligne" onclick="ajouterLigne()">
                        ‚ûï Ajouter une ligne
                    </button>
                </div>

                <!-- Total -->
                <div class="total-display">
                    <div style="margin-bottom: 5px;">Total HT: <span id="total-ht">0.000</span> TND</div>
                    <div style="margin-bottom: 5px;">TVA (19%): <span id="total-tva">0.000</span> TND</div>
                    <h3>Total TTC: <span class="montant" id="total-ttc">0.000</span> TND</h3>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn">‚úÖ Cr√©er BC & Lancer l'approbation</button>
                    <button type="reset" class="btn btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
                </div>
            </form>
        </section>

        <!-- Bons de commande -->
        <section class="card">
            <h2>üì¶ Bons de Commande</h2>
            <table id="bc-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>R√©f. DA</th>
                        <th>Fournisseur</th>
                        <th>Nb Lignes</th>
                        <th>Total TTC</th>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Workflow</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #6b7280;">
                            Chargement...
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <script>
        const API_URL = "http://localhost:8000";
        let ws = null;
        let numeroLigne = 0;

        // WebSocket
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:8000/ws');
                
                ws.onopen = () => {
                    document.getElementById('connection-status').textContent = '‚óè Connect√©';
                    document.getElementById('connection-status').className = 'status-indicator status-connected';
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    switch(message.type) {
                        case 'bc_cree':
                        case 'bc_resoumis':
                            showNotification('BC mis √† jour!', 'success');
                            loadBonsCommande();
                            loadDemandesAchat();
                            break;
                        case 'bc_mis_a_jour':
                        case 'pr_updated':
                            loadBonsCommande();
                            loadDemandesAchat();
                            break;
                    }
                };
                
                ws.onclose = () => {
                    document.getElementById('connection-status').textContent = '‚óè D√©connect√©';
                    document.getElementById('connection-status').className = 'status-indicator status-disconnected';
                    setTimeout(connectWebSocket, 3000);
                };
            } catch (error) {
                console.error('Erreur WebSocket:', error);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Ajouter une ligne
        function ajouterLigne() {
            numeroLigne++;
            const ligneDiv = document.createElement('div');
            ligneDiv.className = 'ligne-item';
            ligneDiv.id = `ligne-${numeroLigne}`;
            ligneDiv.innerHTML = `
                <div class="ligne-header">
                    <h4>Ligne ${numeroLigne}</h4>
                    <button type="button" class="btn-remove-ligne" onclick="supprimerLigne(${numeroLigne})">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Description *</label>
                        <input type="text" class="ligne-description" required placeholder="ex: Ordinateur portable Dell">
                    </div>
                    <div class="form-group">
                        <label>Quantit√© *</label>
                        <input type="number" class="ligne-quantite" min="0.001" step="0.001" value="1" required onchange="calculerTotaux()">
                    </div>
                    <div class="form-group">
                        <label>Unit√© *</label>
                        <input type="text" class="ligne-unite" value="unit√©" required>
                    </div>
                    <div class="form-group">
                        <label>Prix unitaire (TND) *</label>
                        <input type="number" class="ligne-prix" min="0" step="0.001" value="0" required onchange="calculerTotaux()">
                    </div>
                    <div class="form-group">
                        <label>Montant ligne</label>
                        <input type="text" class="ligne-montant" readonly value="0.000 TND">
                    </div>
                    <div class="form-group">
                        <label>R√©f√©rence catalogue</label>
                        <input type="text" class="ligne-reference" placeholder="ex: REF-12345">
                    </div>
                </div>
                <div class="form-group">
                    <label>Sp√©cifications techniques</label>
                    <textarea class="ligne-specs" rows="2" placeholder="D√©tails techniques..."></textarea>
                </div>
            `;
            document.getElementById('lignes-list').appendChild(ligneDiv);
            calculerTotaux();
        }

        function supprimerLigne(num) {
            document.getElementById(`ligne-${num}`).remove();
            calculerTotaux();
        }

        function calculerTotaux() {
            let totalHT = 0;
            document.querySelectorAll('.ligne-item').forEach(ligne => {
                const quantite = parseFloat(ligne.querySelector('.ligne-quantite').value) || 0;
                const prix = parseFloat(ligne.querySelector('.ligne-prix').value) || 0;
                const montant = quantite * prix;
                ligne.querySelector('.ligne-montant').value = montant.toFixed(3) + ' TND';
                totalHT += montant;
            });
            
            const tva = totalHT * 0.19;
            const totalTTC = totalHT + tva;
            
            document.getElementById('total-ht').textContent = totalHT.toFixed(3);
            document.getElementById('total-tva').textContent = tva.toFixed(3);
            document.getElementById('total-ttc').textContent = totalTTC.toFixed(3);
        }

        function resetForm() {
            document.getElementById('bc-form').reset();
            document.getElementById('lignes-list').innerHTML = '';
            numeroLigne = 0;
            ajouterLigne();
            
            // Clear update mode
            const form = document.getElementById('bc-form');
            delete form.dataset.mode;
            delete form.dataset.bcId;
            document.getElementById('submit-btn').textContent = '‚úÖ Cr√©er BC & Lancer l\'approbation';
        }

        // Charger les DAs
        async function loadDemandesAchat() {
            try {
                const res = await fetch(`${API_URL}/demandes-achat`);
                const das = await res.json();

                const tbody = document.querySelector("#da-table tbody");
                const select = document.getElementById("linked_pr_id");

                tbody.innerHTML = "";
                select.innerHTML = '<option value="">S√©lectionner une DA...</option>';

                das.forEach(da => {
                    const row = `
                        <tr>
                            <td><strong>${da.id}</strong></td>
                            <td>${da.demandeur}</td>
                            <td>${da.departement}</td>
                            <td>${da.type_achat}</td>
                            <td>${da.details}</td>
                            <td>${da.date_creation}</td>
                            <td><span class="status-badge" style="background: ${da.statut === 'Active' ? '#10b981' : '#6b7280'}">${da.statut}</span></td>
                            <td>${da.statut === 'Active' ? `<button class="btn-create-bc" onclick="preparerBC('${da.id}')">‚úÖ Cr√©er BC</button>` : '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;

                    if (da.statut === 'Active') {
                        select.innerHTML += `<option value="${da.id}" data-demandeur="${da.demandeur}" data-email="${da.email_demandeur}" data-manager="${da.manager_email}">${da.id} - ${da.details}</option>`;
                    }
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function preparerBC(daId) {
            document.getElementById('linked_pr_id').value = daId;
            const option = document.querySelector(`#linked_pr_id option[value="${daId}"]`);
            if (option) {
                document.getElementById('demandeur_nom').value = option.dataset.demandeur;
                document.getElementById('demandeur_email').value = option.dataset.email;
                document.getElementById('manager_email').value = option.dataset.manager || '';
            }
            document.querySelector('section:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
        }

        // Auto-remplir depuis DA
        document.getElementById('linked_pr_id').addEventListener('change', async function() {
            const daId = this.value;
            if (!daId) return;

            try {
                const res = await fetch(`${API_URL}/demandes-achat/${daId}`);
                const da = await res.json();

                document.getElementById('demandeur_nom').value = da.demandeur;
                document.getElementById('demandeur_email').value = da.email_demandeur;
                document.getElementById('manager_email').value = da.manager_email || '';
                document.getElementById('details_demande').value = da.details;
                document.getElementById('justification').value = da.justification || '';
            } catch (error) {
                console.error('Erreur:', error);
            }
        });

        // Modifier BC
        async function modifierBC(bcId) {
            try {
                showNotification('Chargement du BC...', 'info');
                
                // Fix: Use the correct endpoint structure
                const res = await fetch(`${API_URL}/bons-commande/${bcId}`);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }
                
                const bc = await res.json();
                console.log('BC loaded:', bc);
                
                // Fill the form with BC data
                document.getElementById('linked_pr_id').value = bc.linked_pr_id || '';
                
                // Handle demandeur (can be object or string)
                if (bc.demandeur) {
                    document.getElementById('demandeur_nom').value = 
                        typeof bc.demandeur === 'object' ? (bc.demandeur.nom || '') : bc.demandeur;
                    document.getElementById('demandeur_email').value = 
                        typeof bc.demandeur === 'object' ? (bc.demandeur.email || '') : '';
                }
                
                // Handle manager
                if (bc.manager) {
                    document.getElementById('manager_nom').value = 
                        typeof bc.manager === 'object' ? (bc.manager.nom || '') : '';
                    document.getElementById('manager_email').value = 
                        typeof bc.manager === 'object' ? (bc.manager.email || '') : '';
                }
                
                document.getElementById('type_achat').value = bc.type_achat || 'Produit';
                
                // Handle fournisseur
                if (bc.fournisseur) {
                    document.getElementById('fournisseur_nom').value = 
                        typeof bc.fournisseur === 'object' ? (bc.fournisseur.nom || '') : bc.fournisseur;
                    document.getElementById('fournisseur_email').value = 
                        typeof bc.fournisseur === 'object' ? (bc.fournisseur.email || '') : '';
                    document.getElementById('fournisseur_telephone').value = 
                        typeof bc.fournisseur === 'object' ? (bc.fournisseur.telephone || '') : '';
                }
                
                document.getElementById('priorite').value = bc.priorite || 'Moyenne';
                document.getElementById('date_livraison').value = bc.date_livraison_souhaitee || '';
                document.getElementById('mode_paiement').value = bc.mode_paiement || 'Virement bancaire';
                document.getElementById('details_demande').value = bc.details_demande || '';
                document.getElementById('justification').value = bc.justification || '';
                
                // Clear existing lines
                document.getElementById('lignes-list').innerHTML = '';
                numeroLigne = 0;
                
                // Add lines from BC
                if (bc.lignes && bc.lignes.length > 0) {
                    bc.lignes.forEach(ligne => {
                        ajouterLigne();
                        const ligneDiv = document.getElementById(`ligne-${numeroLigne}`);
                        if (ligneDiv) {
                            ligneDiv.querySelector('.ligne-description').value = ligne.description || '';
                            ligneDiv.querySelector('.ligne-quantite').value = ligne.quantite || 1;
                            ligneDiv.querySelector('.ligne-unite').value = ligne.unite || 'unit√©';
                            ligneDiv.querySelector('.ligne-prix').value = ligne.prix_unitaire || 0;
                            ligneDiv.querySelector('.ligne-reference').value = ligne.reference_catalogue || '';
                            ligneDiv.querySelector('.ligne-specs').value = ligne.specifications_techniques || '';
                        }
                    });
                } else {
                    // If no lines exist, add one empty line
                    ajouterLigne();
                }
                
                calculerTotaux();
                
                // Store BC ID for update
                const form = document.getElementById('bc-form');
                form.dataset.bcId = bcId;
                form.dataset.mode = 'update';
                document.getElementById('submit-btn').textContent = 'üíæ Mettre √† jour le BC';
                
                // Scroll to form
                document.querySelector('section:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
                
                showNotification('BC charg√© - modifiez les donn√©es puis cliquez sur "Mettre √† jour"', 'success');
                
            } catch (error) {
                console.error('Erreur compl√®te:', error);
                showNotification(`Erreur lors du chargement du BC: ${error.message}`, 'error');
            }
        }

        // Resubmit BC
        async function resubmitBC(bcId) {
            if (!confirm('Resoummettre ce BC pour approbation ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/bons-commande/${bcId}/resubmit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (res.ok) {
                    showNotification(`‚úÖ BC ${bcId} resoumis pour approbation!`, 'success');
                    loadBonsCommande();
                    loadDemandesAchat();
                } else {
                    const error = await res.json();
                    showNotification(`Erreur: ${error.detail}`, 'error');
                }
            } catch (error) {
                showNotification('Erreur de connexion', 'error');
            }
        }

        // Soumettre le BC
        document.getElementById('bc-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const lignes = [];
            document.querySelectorAll('.ligne-item').forEach((ligne, index) => {
                const quantite = parseFloat(ligne.querySelector('.ligne-quantite').value);
                const prix = parseFloat(ligne.querySelector('.ligne-prix').value);
                lignes.push({
                    numero_ligne: index + 1,
                    description: ligne.querySelector('.ligne-description').value,
                    quantite: quantite,
                    unite: ligne.querySelector('.ligne-unite').value,
                    prix_unitaire: prix,
                    montant_ligne: quantite * prix,
                    reference_catalogue: ligne.querySelector('.ligne-reference').value || null,
                    specifications_techniques: ligne.querySelector('.ligne-specs').value || null
                });
            });

            if (lignes.length === 0) {
                showNotification('Ajoutez au moins une ligne de commande', 'error');
                return;
            }

            const payload = {
                linked_pr_id: document.getElementById('linked_pr_id').value,
                demandeur: {
                    nom: document.getElementById('demandeur_nom').value,
                    email: document.getElementById('demandeur_email').value
                },
                manager: {
                    nom: document.getElementById('manager_nom').value,
                    email: document.getElementById('manager_email').value
                },
                type_achat: document.getElementById('type_achat').value,
                details_demande: document.getElementById('details_demande').value,
                lignes: lignes,
                devise: "TND",
                fournisseur: {
                    nom: document.getElementById('fournisseur_nom').value,
                    email: document.getElementById('fournisseur_email').value || null,
                    telephone: document.getElementById('fournisseur_telephone').value || null
                },
                priorite: document.getElementById('priorite').value,
                date_livraison_souhaitee: document.getElementById('date_livraison').value || null,
                justification: document.getElementById('justification').value,
                mode_paiement: document.getElementById('mode_paiement').value
            };

            try {
                // Check if we're in update mode
                const form = document.getElementById('bc-form');
                const mode = form.dataset.mode;
                const bcId = form.dataset.bcId;
                
                if (mode === 'update' && bcId) {
                    // UPDATE existing BC
                    const res = await fetch(`${API_URL}/bons-commande/${bcId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const data = await res.json();
                        showNotification(`‚úÖ BC ${bcId} mis √† jour! Vous pouvez maintenant le resoummettre.`, 'success');
                        resetForm();
                        loadBonsCommande();
                        loadDemandesAchat();
                    } else {
                        const error = await res.json();
                        showNotification(`Erreur: ${error.detail}`, 'error');
                    }
                } else {
                    // CREATE new BC
                    const res = await fetch(`${API_URL}/bons-commande`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        const data = await res.json();
                        showNotification(`‚úÖ BC ${data.purchase_order_id} cr√©√© avec ${lignes.length} ligne(s)!`, 'success');
                        resetForm();
                        loadBonsCommande();
                        loadDemandesAchat();
                    } else {
                        const error = await res.json();
                        showNotification(`Erreur: ${error.detail}`, 'error');
                    }
                }
            } catch (error) {
                showNotification('Erreur de connexion', 'error');
            }
        });

        // Charger les BCs
        async function loadBonsCommande() {
            try {
                const res = await fetch(`${API_URL}/bons-commande`);
                const bcs = await res.json();

                const tbody = document.querySelector("#bc-table tbody");
                tbody.innerHTML = "";

                if (bcs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #6b7280;">Aucun bon de commande pour le moment</td></tr>';
                    return;
                }

                bcs.forEach(bc => {
                    const workflowLink = bc.workflow_id 
                        ? `<a href="http://localhost:8001/ui.html?workflow=${bc.workflow_id}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600;">üìã ${bc.workflow_id}</a>`
                        : '<span style="color: #6b7280;">-</span>';
                    
                    const statusColor = bc.status === 'Approuv√©' ? '#10b981' : (bc.status === 'Rejet√©' ? '#ef4444' : (bc.status === 'Brouillon' ? '#f59e0b' : '#3b82f6'));
                    
                    // Add Modify and Resubmit buttons if BC is in Brouillon and has workflow_id
                    let actionButtons = workflowLink;
                    if (bc.status === 'Brouillon' && bc.workflow_id) {
                        actionButtons += `
                            <br>
                            <button onclick="modifierBC('${bc.purchase_order_id}')" 
                                    class="btn-create-bc" 
                                    style="margin-top: 5px; margin-right: 5px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="resubmitBC('${bc.purchase_order_id}')" 
                                    class="btn-create-bc" 
                                    style="margin-top: 5px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                üîÑ Resoummettre
                            </button>
                        `;
                    }
                    
                    tbody.innerHTML += `
                        <tr style="${bc.status === 'Brouillon' && bc.workflow_id ? 'background: #fef3c7;' : ''}">
                            <td><strong>${bc.purchase_order_id}</strong></td>
                            <td>${bc.linked_pr_id}</td>
                            <td>${bc.fournisseur?.nom || 'N/A'}</td>
                            <td>${bc.lignes?.length || 0}</td>
                            <td><strong>${bc.montant_total_ttc?.toFixed(3) || '0.000'} TND</strong></td>
                            <td>${bc.date_creation?.split('T')[0] || '-'}</td>
                            <td><span class="status-badge" style="background: ${statusColor}">${bc.status}</span></td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                });

                console.log(`‚úÖ Loaded ${bcs.length} bons de commande`);
            } catch (error) {
                console.error('Erreur:', error);
                const tbody = document.querySelector("#bc-table tbody");
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #ef4444;">Erreur de chargement</td></tr>';
            }
        }

        // Initial load
        connectWebSocket();
        loadDemandesAchat();
        loadBonsCommande();
        ajouterLigne(); // Add first line by default
    </script>
</body>
</html>